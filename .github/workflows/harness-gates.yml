name: Harness Gates

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: "0 3 * * *"
    - cron: "0 4 * * 0"

jobs:
  governance-and-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Architecture Gate
        run: bash harness/architecture/check-boundaries.sh "$PWD"

      - name: Self Review Evidence
        run: bash harness/review/self-review.sh "$PWD" --strict

      - name: Secondary Review
        run: bash harness/review/secondary-review.sh "$PWD"

      - name: Kill Criteria Gate
        run: bash harness/quality/evaluate-kill-criteria.sh "$PWD" --enforce

  swift-validation:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Full Swift Test Suite
        run: swift test

      - name: Release Build Validation
        run: swift build -c release

  soak-short:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Short Soak Tier
        run: bash harness/quality/run-soak-tests.sh "$PWD" ci

  soak-medium:
    if: github.event_name == 'schedule' && github.event.schedule == '0 3 * * *'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Medium Soak Tier
        run: bash harness/quality/run-soak-tests.sh "$PWD" nightly

  soak-long:
    if: github.event_name == 'schedule' && github.event.schedule == '0 4 * * 0'
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Long Soak Tier
        run: bash harness/quality/run-soak-tests.sh "$PWD" weekly

  api-diff:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure baseline branch refs
        run: git fetch origin main --depth=1

      - name: API Diff Gate
        run: bash harness/quality/check-api-diff.sh "$PWD" "origin/main"
